<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-translate-customization" content="108d9124921d80c3-80e20d618ff053c8-g4f02ec6f3dba68b7-c">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>MapReduce - Performance Tunings | Keep Calm and HAKUNA MATATA</title>
<meta name="generator" content="Jekyll v4.3.3">
<meta property="og:title" content="MapReduce - Performance Tunings">
<meta name="author" content="taehyeok-jang">
<meta property="og:locale" content="en_US">
<meta name="description" content="Introduction">
<meta property="og:description" content="Introduction">
<link rel="canonical" href="/jekyll-theme-yat/distributed-systems/2020/10/18/map-reduce-performance-tunings.html">
<meta property="og:url" content="/jekyll-theme-yat/distributed-systems/2020/10/18/map-reduce-performance-tunings.html">
<meta property="og:site_name" content="Keep Calm and HAKUNA MATATA">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-10-18T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="MapReduce - Performance Tunings">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"taehyeok-jang"},"dateModified":"2020-10-18T00:00:00+00:00","datePublished":"2020-10-18T00:00:00+00:00","description":"Introduction","headline":"MapReduce - Performance Tunings","mainEntityOfPage":{"@type":"WebPage","@id":"/jekyll-theme-yat/distributed-systems/2020/10/18/map-reduce-performance-tunings.html"},"url":"/jekyll-theme-yat/distributed-systems/2020/10/18/map-reduce-performance-tunings.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="shortcut icon" href="">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-noto-sans@0.0.72/index.min.css">
  <link rel="stylesheet" href="/jekyll-theme-yat/assets/css/main.css">
  <script src="/jekyll-theme-yat/assets/js/main.js"></script><link type="application/atom+xml" rel="alternate" href="/jekyll-theme-yat/feed.xml" title="Keep Calm and HAKUNA MATATA">
<script>
  function initGoogleAnalytics() {
    var doNotTrack = (window.doNotTrack === "1" || navigator.doNotTrack === "1" ||
      navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1");
    var enableDNT = "true" == "true";

    if (!enableDNT || !doNotTrack) {
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'G-WWZ625TGVC', 'auto');
      ga('send', 'pageview');
    }
  }
  window.addEventListener("load", initGoogleAnalytics);
</script>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
<!-- and it's easy to individually load additional languages -->
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/go.min.js"></script>



















<script>
// Init highlight js
document.addEventListener('DOMContentLoaded', function(event) {
  var els = document.querySelectorAll('pre code')

  function addLangData(block) {
    var outer = block.parentElement.parentElement.parentElement;
    var lang = block.getAttribute('data-lang');
    for (var i = 0; i < outer.classList.length; i++) {
      var cls = outer.classList[i];
      if (cls.startsWith('language-')) {
        lang = cls;
        break;
      }
    }
    if (!lang) {
      cls = block.getAttribute('class');
      lang = cls ? cls.replace('hljs ', '') : '';
    }
    if (lang.startsWith('language-')) {
      lang = lang.substr(9);
    }
    block.setAttribute('class', 'hljs ' + lang);
    block.parentNode.setAttribute('data-lang', lang);
  }

  function addBadge(block) {
    var enabled = ('true' || 'true').toLowerCase();
    if (enabled == 'true') {
      var pre = block.parentElement;
      pre.classList.add('badge');
    }
  }

  function handle(block) {
    addLangData(block);
    addBadge(block)
    hljs.highlightBlock(block);
  }

  for (var i = 0; i < els.length; i++) {
    var el = els[i];
    handle(el);
  }
});
</script>

<style>
  /* code language badge */
  pre.badge::before {
    content: attr(data-lang);
    color: #fff;
    background-color: #ff4e00;
    padding: 0 .5em;
    border-radius: 0 2px;
    text-transform: uppercase;
    text-align: center;
    min-width: 32px;
    display: inline-block;
    position: absolute;
    right: 0;
  }

  /* fix wrong badge display for firefox browser */
  code > table pre::before {
    display: none;
  }
</style>
</head>
<body>



























































































































<header class="site-header " role="banner">

  <div class="wrapper">
    <div class="site-header-inner">
<span class="site-brand"><a class="site-brand-inner" rel="author" href="/jekyll-theme-yat/">
  <img class="site-favicon" title="Keep Calm and HAKUNA MATATA" src="" onerror="this.style.display='none'">
  Keep Calm and HAKUNA MATATA
</a>
</span><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger">
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewbox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
              </svg>
            </span>
          </label>

          <div class="trigger">
<a class="page-link" href="/jekyll-theme-yat/about.html">ABOUT</a><a class="page-link" href="/jekyll-theme-yat/archives.html">ARCHIVES</a><a class="page-link" href="/jekyll-theme-yat/categories.html">CATEGORIES</a><a class="page-link" href="/jekyll-theme-yat/">HOME</a><a class="page-link" href="/jekyll-theme-yat/tags.html">TAGS</a>









<span class="page-link">



<div id="google_translate_element" style="display: none;">
</div>

<span class="ct-language">
  <ul class="list-unstyled ct-language-dropdown">
    
      <li>
        <a href="#" class="lang-select" data-lang="en">
          
          <img src="https://cdn.countryflags.com/thumbs/united-states-of-america/flag-400.png" title="English">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="fr">
          
          <img src="https://cdn.countryflags.com/thumbs/france/flag-400.png" title="French">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="zh-CN">
          
          <img src="https://cdn.countryflags.com/thumbs/china/flag-400.png" title="Chinese(Simple)">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="ja">
          
          <img src="https://cdn.countryflags.com/thumbs/japan/flag-400.png" title="Japanese">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="ko">
          
          <img src="https://cdn.countryflags.com/thumbs/south-korea/flag-400.png" title="Korean">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="ru">
          
          <img src="https://cdn.countryflags.com/thumbs/russia/flag-400.png" title="Russian">
          
        </a>
      </li>
    
  </ul>
</span>

<script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({
    pageLanguage: 'en',
    autoDisplay: false,
    layout: google.translate.TranslateElement.InlineLayout.VERTICAL
  }, 'google_translate_element');

  // Links to cross-origin destinations are unsafe
  var gll = document.getElementsByClassName('goog-logo-link')[0];
  if (gll) {
    gll.setAttribute('rel', 'noopener');
  }

  function restoreLang() {
    var iframe = document.getElementsByClassName('goog-te-banner-frame')[0];
    if (!iframe) return;

    var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
    var restore_el = innerDoc.getElementsByTagName("button");

    for (var i = 0; i < restore_el.length; i++) {
      if (restore_el[i].id.indexOf("restore") >= 0) {
        restore_el[i].click();
        var close_el = innerDoc.getElementsByClassName("goog-close-link");
        close_el[0].click();
        return;
      }
    }
  }

  function triggerHtmlEvent(element, eventName) {
    var event;
    if (document.createEvent) {
      event = document.createEvent('HTMLEvents');
      event.initEvent(eventName, true, true);
      element.dispatchEvent(event);
    } else {
      event = document.createEventObject();
      event.eventType = eventName;
      element.fireEvent('on' + event.eventType, event);
    }
  }

  var googleCombo = document.querySelector("select.goog-te-combo");
  var langSelect = document.querySelector('.ct-language');
  langSelect.addEventListener('click', function(event) {
    if (!event.target) {
      return;
    }

    var selected = document.querySelector('.ct-language .ct-language-selected');
    if (selected) {
      selected.classList.remove('ct-language-selected');
    }

    var target = event.target;
    while (target && target !== langSelect ) {
      if (target.matches('.lang-select')) {
        break;
      }
      target = target.parentElement;
    }

    if (target && target.matches('.lang-select')) {
      var lang = target.getAttribute('data-lang');
      if (googleCombo.value == lang) {
        restoreLang();
      } else {
        target.parentElement.classList.add('ct-language-selected');
        googleCombo.value = lang;
        triggerHtmlEvent(googleCombo, 'change');
      }
    }

    event.preventDefault();
  });
}
</script>

<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</span>
</div>
        </nav>
</div>
  </div>
</header>

<script>
  function initHeader() {
    var lastScrollY = getScrollPos().y;
    var documentElement = document.documentElement;

    function storeScrollData() {
      var y = getScrollPos().y;var scrollStatus = "";

      if (y <= 0) {
        scrollStatus = "top";
      } else if ((window.innerHeight + y) >= document.body.offsetHeight) {
        scrollStatus = "bottom";
      } else {
        var isScrollDown = (y - lastScrollY > 0) ? true : false;
        scrollStatus = isScrollDown ? "down" : "up";
      }

      lastScrollY = y;
      documentElement.setAttribute("data-scroll-status", scrollStatus);
    }

    window.addEventListener('scroll', function(e) {
      storeScrollData();
    });

    storeScrollData();
  }
  document.addEventListener('DOMContentLoaded', initHeader);
</script>
















































































































































<script>
  function hashLocate(hashValue) {
    hashValue = hashValue.replace(/^.*#h-/, '');
    hashValue = decodeURIComponent(hashValue);
    var element = document.getElementById(hashValue);

    if (!element) {
      return;
    }

    var header = document.querySelector('header.site-header');
    var headerRect = header.getBoundingClientRect();
    var headerTop = Math.floor(headerRect.top);
    var headerHeight = Math.floor(headerRect.height);
    var scrollPos = getScrollPos();
    var offsetY = element.offsetTop - (headerTop + headerHeight + 20);

    if (offsetY == scrollPos.y) {
      return;
    }

    if (headerTop == 0  && offsetY > scrollPos.y) {
      offsetY += headerHeight + 2;
    } else if (headerTop < 0  && offsetY < scrollPos.y) {
      offsetY -= headerHeight - 2;
    }

    smoothScrollTo(offsetY);
  }

  // The first event occurred
  window.addEventListener('load', function(event) {
    if (window.location.hash) {
      hashLocate(window.location.hash);
    }
  });

  // The first event occurred
  window.addEventListener('click', function(event) {
    if (event.target.tagName.toLowerCase() == 'a') {
      hashLocate(event.target.getAttribute('href'));
    }
  });
</script>
<div class="theme-toggle">
  <input type="checkbox" id="theme-switch">
  <label for="theme-switch">
    <div class="toggle"></div>
    <div class="names">
      <p class="light">Light</p>
      <p class="dark">Dark</p>
    </div>
  </label>
</div>




<script>
  (function() {
    var sw = document.getElementById('theme-switch');
    var html = document.getElementsByTagName('html')[0];
    var nightModeOption = ('auto' || 'auto').toLowerCase();
    var storage = nightModeOption === 'manual'
        ? localStorage
        : sessionStorage;
    var themeData = loadThemeData();

    function saveThemeData(data) {
      storage.setItem('theme', JSON.stringify(data));
    }

    function loadThemeData() {
      var data = storage.getItem('theme');
      try {
        data = JSON.parse(data ? data : '');
      } catch(e) {
        data = { nightShift: undefined, autoToggleAt: 0 };
        saveThemeData(data);
      }
      return data;
    }

    function handleThemeToggle(nightShift) {
      themeData.nightShift = nightShift;
      saveThemeData(themeData);
      html.dataset.theme = nightShift ? 'dark' : 'light';
      setTimeout(function() {
        sw.checked = nightShift ? true : false;
      }, 50);
    }

    function autoThemeToggle() {
      // Next time point of theme toggle
      var now = new Date();
      var toggleAt = new Date();
      var hours = now.getHours();
      var nightShift = hours >= 19 || hours <=7;

      if (nightShift) {
        if (hours > 7) {
          toggleAt.setDate(toggleAt.getDate() + 1);
        }
        toggleAt.setHours(7);
      } else {
        toggleAt.setHours(19);
      }

      toggleAt.setMinutes(0);
      toggleAt.setSeconds(0);
      toggleAt.setMilliseconds(0)

      var delay = toggleAt.getTime() - now.getTime();

      // auto toggle theme mode
      setTimeout(function() {
        handleThemeToggle(!nightShift);
      }, delay);

      return {
        nightShift: nightShift,
        toggleAt: toggleAt.getTime()
      };
    }

    // Listen the theme toggle event
    sw.addEventListener('change', function(event) {
      handleThemeToggle(event.target.checked);
    });

    if (nightModeOption == 'auto') {
      var data = autoThemeToggle();

      // Toggle theme by local setting
      if (data.toggleAt > themeData.autoToggleAt) {
        themeData.autoToggleAt = data.toggleAt;
        handleThemeToggle(data.nightShift);
      } else {
        handleThemeToggle(themeData.nightShift);
      }
    } else if (nightModeOption == 'manual') {
      handleThemeToggle(themeData.nightShift);
    } else {
      var nightShift = themeData.nightShift;
      if (nightShift === undefined) {
        nightShift = nightModeOption === 'on';
      }
      handleThemeToggle(nightShift);
    }
  })();
</script>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="framework">
  <section class="main">

     <div class="post">
  <section>









<header class="post-header">
  <h1 class="post-title p-name" itemprop="name headline">MapReduce - Performance Tunings</h1>
  <h2 class="post-subtitle"></h2>

  <p class="post-meta">
    <time class="dt-published" datetime="2020-10-18T00:00:00+00:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Oct 18, 2020
    </time>

    
    
































    <span class="post-reading-time left-vsplit"><i class="fa fa-clock-o"></i> About 7 mins</span>
  </p>
<div class="post-tags">
<a class="post-tag" href="/jekyll-theme-yat/tags.html#paper-review">#paper-review</a><a class="post-tag" href="/jekyll-theme-yat/tags.html#distributed-systems">#distributed-systems</a><a class="post-tag" href="/jekyll-theme-yat/tags.html#map-reduce">#map-reduce</a>
</div></header>
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="post-content e-content" itemprop="articleBody">

      <h2 id="introduction">Introduction</h2>

<p><a href="https://taehyeok-jang.github.io/distributed-systems/2020/08/09/paper-review-map-reduce.html">(Paper Review) MapReduce - Simplified Data Processing on Large Clusters</a></p>

<p>이전에 위 논문을 리뷰하면서 Google의 MapReduce에 대해서 알아보았습니다. MapReduce 어플리케이션은 대량의 데이터를 처리하기에 수행 성능 및 처리 결과에 대해서 반드시 유의해야 합니다. 이번 글에서는 MapReduce 작업을 수행할 때 작업 성능 및 데이터 정합성에 영향을 미치는 몇가지 설정들을 알아보고자 합니다.</p>

<h2 id="speculative-execution">Speculative Execution</h2>

<p>speculative execution은 MapReduce 수행 도중 특정 worker node에서 task 수행이 지연되고 있으면 해당 task와 동일한 backup task를 실행시키는 것을 허용하는 설정입니다.  MapReduce Job 클래스에서 작업 실행 전 speculative execution 여부를 설정할 수 있습니다.</p>

<p><a href="https://hadoop.apache.org/docs/r1.2.1/api/org/apache/hadoop/mapreduce/Job.html">https://hadoop.apache.org/docs/r1.2.1/api/org/apache/hadoop/mapreduce/Job.html</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**
 * Turn speculative execution on or off for this job. 
 * 
 * @param speculativeExecution &lt;code&gt;true&lt;/code&gt; if speculative execution 
 *                             should be turned on, else &lt;code&gt;false&lt;/code&gt;.
 */
public void setSpeculativeExecution(boolean speculativeExecution) {
  ensureState(JobState.DEFINE);
  conf.setSpeculativeExecution(speculativeExecution);
}
</code></pre></div></div>

<p>Google MapReduce 논문에는 다음과 같이 설명하고 있습니다.</p>

<blockquote>
  <h3 id="36-backup-tasks">3.6 Backup Tasks</h3>

  <p>MapReduce의 수행시간을 길게하는 원인 중 하나로 <strong>straggler가 있다.</strong> straggler는 소수의 map task 혹은 reduce task를 수행하는 데 비정상적으로 긴 시간을 소요하는 machine을 의미한다. straggler는 여러 이유에서 발생한다. bad disk, scheduling으로 인한 CPU, memory, disk, network bandwidth 등 자원의 경합이 될 수 있다. 최근에 발견한 bug로는 processor cache를 disable 시키는 initialization code도 있었다.</p>

  <p>이러한 straggler로 인한 문제를 완화하기 위해서 <strong>general mechanism</strong>을 도입하였다. <strong>MapReduce operation이 수행 완료에 가까워지면 master는 남아있는 in-progress task에 대한 backup execution을 schedule 한다.</strong> 그러면 그 task는 primary 혹은 backup execution에서 완료하게 된다. 논문에서는 이 mechanism을 tune 하여 수 percent의 추가 자원을 사용하면서 수행 완료시간을 상당히 줄이는 결과를 얻었다.</p>
</blockquote>

<p>논문에서는 speculative execution을 활성화시킴으로써 부분 실패에 대한 작업 지연을 미리 예방하여 성능 향상에 기여한다고 이야기하고 있습니다.</p>

<p>하지만, 언제나 speculative execution을 활성화시키는 것만이 능사는 아닙니다. 이는 MapReduce 작업의 실행 환경과 대상이 되는 application의 특성에 따라 달라질 수 있습니다.</p>

<p>Enterprise Hadoop cluster 환경에서는 다수의 MapReduce 작업이 한 cluster 내에서 실행됩니다. 각 MapReduce 작업 별 적당한 throughput과 예상 수행완료 시점을 정하기 위해서는 적정 수준 parallelism이 필요하며 map task, reduce task의 개수를 통해 parallelism을 정한다. 하지만 backup task가 실행되면 추가적인 병렬처리가 발생하게 되며 이에 따라 더 많은 resource, network를 사용하게 된다. 조금 더 예측 가능한 리소스 관리가 요구되는 환경이라면 speculative execution을 off 해야합니다.</p>

<p>또한 application의 특성에 따라 달라질 수 있습니다. MapReduce 작업을 통해 application에 read/write를 수행하기도 하는데 만약 application에서 write에 대해 exactly-once semantic을 요구한다면 speculative execution을 반드시 off 해야합니다. 만약 처리 지연 혹은 부분 실패에 따른 backup task가 생성되었는데 일정 기간 이후 원래 task가 처리되고 backup task 또한 처리된다면 중복 쓰기가 발생하기 때문입니다.</p>

<h2 id="table-scan">Table Scan</h2>

<p>MapReduce 를 활용한 작업 중에서는 저장소에 있는 데이터를 읽어서 연산을 하는 경우도 있습니다. 이때 대량의 데이터를 scan하는 경우 MapReduce 내 클라이언트 프로세스 혹은 저장소에 부하가 발생할 수도 있기 때문에 이와 관련된 제어는 반드시 필요합니다. 이 글에서는 Hadoop HBase를 사용한 예시를 들겠지만, scan caching 및 batch와 관련된 제어는 다른 데이터베이스에도 동일한 원리로 최적화할 수 있을 것이라 기대합니다.</p>

<h3 id="cache-block">Cache Block</h3>

<p><a href="https://hbase.apache.org/1.1/apidocs/org/apache/hadoop/hbase/client/Scan.html">https://hbase.apache.org/1.1/apidocs/org/apache/hadoop/hbase/client/Scan.html</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- setCacheBlocks

public Scan setCacheBlocks(boolean cacheBlocks)

Set whether blocks should be cached for this Scan.
This is true by default. When true, default settings of the table and family are used (this will never override caching blocks if the block cache is disabled for that family or entirely).
</code></pre></div></div>

<p>HBase의 scan 설정 중에는 각 region server 별로 cache block을 제어하는 옵션이 있습니다. 기본적으로는 true로 되어있어 어플리케이션 수행 중 빈번하게 read/write 되는 데이터에 효율적으로 접근할 수 있도록 합니다.</p>

<p>하지만 MapReduce 작업을 위해서는 해당 설정을 비활성화하는 것이 더 효율적일 수 있습니다. MapReduce 작업에서 full scan을 수행하여 저장소 내 전체 데이터 읽는 상황인데, cache block이 적용되어 있으면 page fault가 과도하게 발생하여 오히려 성능 저하를 초래할 수 있습니다.</p>

<h3 id="caching-vs-batch">Caching vs Batch</h3>

<p>HBase scan의 경우 한 row 당 한번에 RPC call이 발생합니다. 이러한 방식은 크기가 작은 cell을 처리할 때 비효율적인데 클러스터 내에서 빈번한 network transfer은 네트워크 부하로 이어지기 때문입니다. 따라서 한번의 RPC call을 통해 여러 row를 반환하는 것이 더 효율적일 수 있다.</p>

<p>HBase에서는 한번의 RPC을 통해 반환할 row, column 개수를 제어할 수 있습니다.</p>

<p><a href="https://hbase.apache.org/1.1/apidocs/org/apache/hadoop/hbase/client/Scan.html">https://hbase.apache.org/1.1/apidocs/org/apache/hadoop/hbase/client/Scan.html</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- setCaching
public Scan setCaching(int caching)

Set the number of rows for caching that will be passed to scanners. If not set, the Configuration setting HConstants.HBASE_CLIENT_SCANNER_CACHING will apply. Higher caching values will enable faster scanners but will use more memory.

- setBatch
public Scan setBatch(int batch)

Set the maximum number of values to return for each call to next(). Callers should be aware that invoking this method with any value is equivalent to calling setAllowPartialResults(boolean) with a value of true; partial results may be returned if this method is called. Use setMaxResultSize(long)} to limit the size of a Scan's Results instead.
</code></pre></div></div>

<p>높은 cache ratio는 신속한 scan을 제공하지만 메모리를 더 사용하므로 주의해야 합니다. 대량의 rows를 scan 해야하는 상황이라면 최악의 경우 클라이언트 프로세스의 maximum heap 크기 초과로 인해 OutOfMemoryException 가 발생할 수도 있습니다.</p>

<p>HBase에서는 이에 대한 답으로서 batching을 도입하였습니다. Batching은 스캔 작업에서 한 번에 가져올 column의 수를 지정하는 데 사용됩니다. 각 row는 여러 column으로 구성되어 있으므로 이 설정은 각 Result instance에 포함될 column 수를 제어합니다. 더 많은 column을 한 번에 가져오면 scan 작업의 효율성이 향상될 수 있습니다.</p>

<p>scanner의 caching과 batching size의 조합은 scan 명령어로 발생할 RPC call의 수를 결정합니다. <a href="https://www.oreilly.com/library/view/hbase-the-definitive/9781449314682/">HBase: The Definitive Guide</a> 의 3장에 예시를 인용합니다. 주어진 테이블은 각각 10개의 column을 가진 2개의 column family, 총 10개의 row로 이루어져 있습니다. 즉 row 당 20개의 column, 그리고 총 200개의 cell로 이루어진 테이블입니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Example 3-20. Using caching and batch parameters for scans</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">scan</span><span class="o">(</span><span class="kt">int</span> <span class="n">caching</span><span class="o">,</span> <span class="kt">int</span> <span class="n">batch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">Logger</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="s">"org.apache.hadoop"</span><span class="o">);</span>
    <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">counters</span> <span class="o">=</span> <span class="o">{</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">};</span>
    <span class="nc">Appender</span> <span class="n">appender</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AppenderSkeleton</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">append</span><span class="o">(</span><span class="nc">LoggingEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getMessage</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"Call: next"</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">counters</span><span class="o">[</span><span class="mi">0</span><span class="o">]++;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">requiresLayout</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">};</span>
    <span class="n">log</span><span class="o">.</span><span class="na">removeAllAppenders</span><span class="o">();</span>
    <span class="n">log</span><span class="o">.</span><span class="na">setAdditivity</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">addAppender</span><span class="o">(</span><span class="n">appender</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">setLevel</span><span class="o">(</span><span class="nc">Level</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">);</span>
    <span class="nc">Scan</span> <span class="n">scan</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scan</span><span class="o">();</span>
    <span class="n">scan</span><span class="o">.</span><span class="na">setCaching</span><span class="o">(</span><span class="n">caching</span><span class="o">);</span>
    <span class="n">scan</span><span class="o">.</span><span class="na">setBatch</span><span class="o">(</span><span class="n">batch</span><span class="o">);</span>
    <span class="nc">ResultScanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="na">getScanner</span><span class="o">(</span><span class="n">scan</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Result</span> <span class="n">result</span> <span class="o">:</span> <span class="n">scanner</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">counters</span><span class="o">[</span><span class="mi">1</span><span class="o">]++;</span>
    <span class="o">}</span>
    <span class="n">scanner</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Caching: "</span> <span class="o">+</span> <span class="n">caching</span> <span class="o">+</span> <span class="s">", Batch: "</span> <span class="o">+</span> <span class="n">batch</span> <span class="o">+</span>
            <span class="s">", Results: "</span> <span class="o">+</span> <span class="n">counters</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">+</span> <span class="s">", RPCs: "</span> <span class="o">+</span> <span class="n">counters</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>아래의 표는 caching과 batching size의 조합에 따른 RPC call의 횟수입니다. caching/batch 각각 1로 설정했을 때 cell의 개수만큼 RPC call이 발생하였고, 5/100, 5/20, 10/10 조합일 때 최적의 성능을 보이고 있습니다. 따라서 MapReduce application에서는 테이블 스키마, data의 저장 패턴 등을 고려하여 caching과 batching size의 조합을 잘 찾는다면 최적의 성능을 얻을 수 있을 것입니다.</p>

<p><img src="https://github.com/taehyeok-jang/taehyeok-jang.github.io/assets/31732943/749fcd79-ed81-44ef-800c-4c7b2c037f3a" alt="scan-batch"></p>

<h2 id="references">References</h2>

<ul>
  <li>Apache Hadoop MapReduce
    <ul>
      <li><a href="https://github.com/apache/hadoop-mapreduce/blob/307cb5b316e10defdbbc228d8cdcdb627191ea15/src/java/org/apache/hadoop/mapreduce/Job.java#L778-L780">https://github.com/apache/hadoop-mapreduce/blob/307cb5b316e10defdbbc228d8cdcdb627191ea15/src/java/org/apache/hadoop/mapreduce/Job.java#L778-L780</a></li>
      <li><a href="https://hadoop.apache.org/docs/r1.2.1/api/org/apache/hadoop/mapreduce/Job.html">https://hadoop.apache.org/docs/r1.2.1/api/org/apache/hadoop/mapreduce/Job.html</a></li>
    </ul>
  </li>
  <li>Apache HBase
    <ul>
      <li><a href="https://hbase.apache.org/1.1/apidocs/org/apache/hadoop/hbase/client/Scan.html">https://hbase.apache.org/1.1/apidocs/org/apache/hadoop/hbase/client/Scan.html</a></li>
      <li><a href="https://www.oreilly.com/library/view/hbase-the-definitive/9781449314682/">HBase: The Definitive Guide</a></li>
    </ul>
  </li>
</ul>


    </div>

</article>
<div class="post-nav">
<a class="previous" href="/jekyll-theme-yat/database/2020/09/27/algorithms-behind-modern-storage-systems.html" title="(Paper Review) Algorithms Behind Modern Storage Systems">(Paper Review) Algorithms Behind Modern Storage...</a><a class="next" href="/jekyll-theme-yat/database/2021/05/12/redis-intro.html" title="Redis Introduction">Redis Introduction</a>
</div>
<div class="post-related">
      <div>Related Articles</div>
      <ul>
        <li><a class="post-link" href="/jekyll-theme-yat/gatech/2024/01/08/cse6250-1-intro-to-bd4h.html" title="Redis Introduction">CSE6250 Big Data for Healthcare - 1. Intro</a></li>
<li><a class="post-link" href="/jekyll-theme-yat/stream-processing/2021/10/15/apache-kafka-reliable-messaging.html" title="Redis Introduction">Apache Kafka - How to Achieve Reliable Messaging</a></li>
<li><a class="post-link" href="/jekyll-theme-yat/distributed-systems/2020/08/23/paper-review-the-google-file-system-1.html" title="Redis Introduction">(Paper Review) The Google File System - Part 1</a></li>
<li><a class="post-link" href="/jekyll-theme-yat/database/2023/04/01/clickhouse-internal.html" title="Redis Introduction">Clickhouse - Internal</a></li>
</ul>
    </div>
<div class="post-comments"></div></section>
</div>


  </section>
  <section class="sidebar" style="margin-left: 15px;">
    <!-- Get sidebar items --><style type="text/css" media="screen">
.post-menu ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
</style>

<div class="post-menu">
  <div class="post-menu-title">TOC</div>
  <div class="post-menu-content"></div>
</div>

<script>
  function generateContent() {
    var menu = document.querySelector(".post-menu");
    var menuContent =  menu.querySelector(".post-menu-content");
    var headings = document.querySelector(".post-content").querySelectorAll("h2, h3, h4, h5, h6");

    // Hide menu when no headings
    if (headings.length === 0) {
      return menu.style.display = "none";
    }

    // Generate post menu
    var menuHTML = '';
    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      menuHTML += (
        '<li class="h-' + h.tagName.toLowerCase() + '">'
        + '<a href="#h-' + h.getAttribute('id') + '">' + h.textContent + '</a></li>');
    }

    menuContent.innerHTML = '<ul>' + menuHTML + '</ul>';

    // The header element
    var header = document.querySelector('header.site-header');

    function doMenuCollapse(index, over_items) {
      var items = menuContent.firstChild.children;

      if (over_items == undefined) {
        over_items = 20;
      }

      if (items.length < over_items) {
        return;
      }

      var activeItem = items[index];
      var beginItem = activeItem
      var endItem = activeItem
      var beginIndex = index;
      var endIndex = index + 1;
      while (beginIndex >= 0
        && !items[beginIndex].classList.contains('h-h2')) {
        beginIndex -= 1;
      }
      while (endIndex < items.length
        && !items[endIndex].classList.contains('h-h2')) {
        endIndex += 1;
      }
      for (var i = 0; i < beginIndex; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
      for (var i = beginIndex + 1; i < endIndex; i++) {
        item = items[i]
        // if (!item.classList.contains('h-h2')) {
          item.style.display = '';
        // }
      }
      for (var i = endIndex; i < items.length; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
    }

    // Init menu collapsed
    doMenuCollapse(-1);

    // Active the menu item
    window.addEventListener('scroll', function (event) {
      var lastActive = menuContent.querySelector('.active');
      var changed = true;
      var activeIndex = -1;
      for (var i = headings.length - 1; i >= 0; i--) {
        var h = headings[i];
        var headingRect = h.getBoundingClientRect();
        var headerRect = header.getBoundingClientRect();
        var headerTop = Math.floor(headerRect.top);
        var headerHeight = Math.floor(headerRect.height);
        var headerHeight = headerTop + headerHeight + 20;
        if (headingRect.top <= headerHeight) {
          var id = 'h-' + h.getAttribute('id');
          var a = menuContent.querySelector('a[href="#' + id  + '"]');
          var curActive = a.parentNode;
          if (curActive) {
            curActive.classList.add('active');
            activeIndex = i;
          }
          if (lastActive == curActive) {
            changed = false;
          }
          break;
        }
      }
      if (changed) {
        if (lastActive) {
          lastActive.classList.remove('active');
        }
        doMenuCollapse(activeIndex);
      }
      event.preventDefault();
    });
  }
  generateContent();
</script>
</section>
</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/jekyll-theme-yat/"></data>

  <div class="wrapper">
    <div class="site-footer-inner">
<div>Unpublished Work <span class="copyleft">©</span> 2017-2024 TaeHyeok Jang</div>
      <div>Powered by <a title="Jekyll is a simple, blog-aware, static site
      generator." href="http://jekyllrb.com/">Jekyll</a> &amp; <a title="Yat, yet
      another theme." href="https://github.com/jeffreytse/jekyll-theme-yat">Yat Theme</a>.</div>
      <div class="footer-col rss-subscribe">Subscribe <a href="/jekyll-theme-yat/feed.xml">via RSS</a>
</div>
    </div>
  </div>
</footer>
</body>
</html>
