I"­<p>[toc]</p>

<p>ì§€ë‚œ ê¸€ì—ì„œëŠ” Kafka consumerì—ì„œ ì™œ ë™ì‹œì²˜ë¦¬ê°€ í•„ìš”í•œì§€, consumer ë‚´ ë™ì‹œì²˜ë¦¬ë¥¼ êµ¬í˜„í•œ Confluent ì‚¬ì˜ ì‚¬ë¡€ì™€ ê·¸ í•œê³„ì ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  consumerì˜ ì„±ëŠ¥ì„ ìµœëŒ€ë¡œ í•˜ê¸° ìœ„í•´ì„œëŠ” ê²°êµ­ í•œ partition ë‚´ì—ì„œë„ ë™ì‹œì²˜ë¦¬ê°€ í•„ìš”í•˜ë‹¤ëŠ” ê²°ë¡ ì„ ì–»ì—ˆìŠµë‹ˆë‹¤.</p>

<p>ì´ë²ˆ ê¸€ì—ì„œëŠ” Decatonì—ì„œ ë™ì¼í•œ ë¬¸ì œë¥¼ ì–´ë–»ê²Œ ì ‘ê·¼í•˜ê³  ìˆëŠ”ì§€, ë‹¨ì¼ partition ë‚´ ë™ì‹œì²˜ë¦¬ ëª¨ë¸ì„ ì–´ë–»ê²Œ êµ¬í˜„í–ˆëŠ”ì§€ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.</p>

<h2 id="why-decaton">Why Decaton?</h2>

<p>ì§€ë‚œ ê¸€ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ I/O intensiveí•œ taskë¥¼ ì²˜ë¦¬í•˜ëŠ” consumerë¥¼ ì˜ˆë¥¼ ë“¤ê² ìŠµë‹ˆë‹¤. consumerì—ì„œëŠ” taskë¥¼ consumerí•˜ì—¬ ì™¸ë¶€ ì‹œìŠ¤í…œì˜ APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ì´ API í˜¸ì¶œì— ì‹œê°„ì´ ì˜¤ë˜ ì†Œìš”ë˜ëŠ” íƒ“ì— consumer group ë‚´ ê° consumerì—ì„œëŠ” ê¸´ wait timeì„ ê°€ì§€ê²Œ ë˜ê³  ì´ëŠ” ê²°êµ­ ì „ì²´ì ì¸ ë©”ì‹œì§€ ì²˜ë¦¬ ì„±ëŠ¥ ì €í•˜ë¡œ ì´ì–´ì§‘ë‹ˆë‹¤. ë§Œì•½ consumer groupì˜ ë³‘ë ¬ì„±ì´ partitionì˜ ê°œìˆ˜ì™€ ê°™ê³ , ì™¸ë¶€ ì‹œìŠ¤í…œì€ ë” ë†’ì€ ë¹ˆë„ì˜ API í˜¸ì¶œì„ ìˆ˜ìš©í•  ìˆ˜ ìˆë‹¤ë©´ í˜„ì¬ ì‹œìŠ¤í…œ ìƒì—ì„œëŠ” consumer groupì´ ìœ ì¼í•œ ë³‘ëª©ì…ë‹ˆë‹¤. ì´ ë¬¸ì œë¥¼ ì‹œìŠ¤í…œ ìš´ì˜ ìƒì˜ ê´€ì ìœ¼ë¡œ ë³´ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</p>

<ul>
  <li>ì‚¬ìš©ì ë¬¸ì œ
    <ul>
      <li>ì‚¬ìš©ìê°€ í˜¼ìì„œ concurrencyë¥¼ ì¡°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì¹´í”„ì¹´ í´ëŸ¬ìŠ¤í„°ì˜ ì•ˆì •ì  ìš´ì˜ì„ ìœ„í•´ì„œëŠ” ì ì ˆí•œ ì •ì±…ê³¼ capacity planningì„ í†µí•´ ì‹œìŠ¤í…œ ê´€ë¦¬ìê°€ partition ê°œìˆ˜ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤.</li>
      <li>ì‹œìŠ¤í…œì˜ ì´ˆê¸°ì—ëŠ” ìš”êµ¬ë˜ëŠ” concurrencyë¥¼ ì¸¡ì •í•˜ê¸°ê°€ ì–´ë µìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ partitionì€ ì¶•ì†Œì‹œí‚¤ëŠ” ê²ƒì´ ë¶ˆê°€ëŠ¥í•˜ê³  partition ìˆ˜ë¥¼ ëŠ˜ë¦¬ëŠ” ê²ƒì€ ë¶€ì‘ìš©ì´ ì•¼ê¸°í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ì‹œìŠ¤í…œ ê´€ë¦¬ìì˜ ë¬¸ì œ
    <ul>
      <li>ë” ë§ì€ partitionì€ ë”ë§ì€ SW/HW ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
      <li>producerëŠ” ì´ì „ë³´ë‹¤ ë” ì‘ì€ í¬ê¸°ì˜ batchë¥¼ ë°œìƒì‹œí‚¤ë©° ì´ëŠ” broker ì…ì¥ì—ì„œ ë¹„íš¨ìœ¨ì ì…ë‹ˆë‹¤.</li>
      <li>Kafka 1.1.0ì—ì„œ ì•„ì£¼ ë§ì€ ìˆ˜ì˜ partitionë¥¼ ê°€ì§€ëŠ” ê²ƒì— ëŒ€í•œ í° ê°œì„ ì´ ìˆì—ˆì§€ë§Œ, ì—¬ì „íˆ partitionì€ replica assignmentì˜ ê¸°ë³¸ ë‹¨ìœ„ì´ê¸° ë•Œë¬¸ì— ë§ì€ ìˆ˜ì˜ partitionì„ ê°€ì§€ëŠ” ê²ƒì€ reassignment ê³¼ì •ì„ ëŠë¦¬ê²Œ í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<p>Decatonì€ ìœ„ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ê°œì„ ì„ ì´ë£¨ì—ˆìŠµë‹ˆë‹¤.</p>

<ul>
  <li>ë‹¨ì¼ partition ë‚´ ë™ì‹œì²˜ë¦¬ë¥¼ ì§€ì›í•©ë‹ˆë‹¤
    <ul>
      <li>Sliding offset commitì„ í†µí•´ ë™ì‹œì²˜ë¦¬ì— ë”°ë¥¸ ë©”ì‹œì§€ ì²˜ë¦¬ ëˆ„ë½ì„ ë°©ì§€í•©ë‹ˆë‹¤</li>
      <li>ë™ì¼í•œ keyì˜ ë©”ì‹œì§€ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì„ ë³´ì¥í•©ë‹ˆë‹¤</li>
    </ul>
  </li>
  <li>Dynamic property configurationìœ¼ë¡œ í•œ partition ë‚´ concurrencyë¥¼ ë™ì ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
</ul>

<h2 id="offset-commit-coordination">Offset Commit Coordination</h2>

<p>Decatonì˜ offset commit ì „ëµì„ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤. ë‹¨ì¼ partition ë‚´ ë™ì‹œì²˜ë¦¬ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•˜ê¸° ìœ„í•´ì„œëŠ” offset commit coordinationì´ í•„ìš”í•©ë‹ˆë‹¤. Kafkaì˜ offset commitì€ watermark ë°©ì‹ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ 5ë²ˆ recordë¥¼ commit í•˜ë©´ ì´ëŠ” 1~5ë²ˆ record ëª¨ë‘ commit í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ë§Œì•½ 1ë²ˆ recordë¥¼ ì²˜ë¦¬í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆê±°ë‚˜ ì§€ì—°ë˜ê³  ìˆëŠ”ë°ë„ 5ë²ˆ recordë¥¼ commit í•œë‹¤ë©´ 1ë²ˆ recordê°€ ì²˜ë¦¬ë˜ì§€ ì•Šê³  ìœ ì‹¤ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¨ì¼ ìŠ¤ë ˆë“œ ëª¨ë¸ì—ì„œëŠ” ë©”ì‹œì§€ë“¤ì´ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬ë˜ê¸° ë•Œë¬¸ì— ìƒê´€ ì—†ì§€ë§Œ, ì—¬ëŸ¬ ë©”ì‹œì§€ë“¤ì„ ë™ì‹œì— ì²˜ë¦¬í•˜ëŠ” ë™ì‹œì²˜ë¦¬ ëª¨ë¸ì—ì„œëŠ” ì´ ê°™ì€ ì¼ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ë™ì‹œì²˜ë¦¬ ëª¨ë¸ì—ì„œ ì²˜ë¦¬ ê²°ê³¼ë¥¼ ë³´ì¥í•˜ê¸° ìœ„í•´ì„œëŠ” 5ë²ˆ recordë¥¼ commit í•˜ê¸° ì „ì— ì´ì „ì˜ ëª¨ë“  recordë“¤ì´ ì²˜ë¦¬ê°€ ì™„ë£Œëœ ê²ƒì„ í™•ì¸í•œ ë‹¤ìŒì— commit í•´ì•¼ í•©ë‹ˆë‹¤.</p>

<p>Decatonì—ì„œëŠ” offset commit coordinationì„ ìœ„í•˜ì—¬ sliding offeset range ë°©ì‹ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. Decatonì—ì„œëŠ” ê° partition ë³„ë¡œ íë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©´ì„œ ê° ë©”ì‹œì§€ì˜ offsetê³¼ ì²˜ë¦¬ ì™„ë£Œ ì—¬ë¶€ë¥¼ ì €ì¥í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ì£¼ê¸°ì ìœ¼ë¡œ commitì„ ì‹œë„í•  ë•Œ íì˜ ê°€ì¥ ì•ì— ìˆëŠ” offsetë¶€í„° ì²˜ë¦¬ê°€ ì™„ë£Œëœ offsetê¹Œì§€ë¥¼ commit í•©ë‹ˆë‹¤. ì•„ë˜ ê·¸ë¦¼ì„ í†µí•´ ë™ì‘ ë°©ì‹ì„ ì´í•´í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<p><img src="/Users/tajang12/Documents/workspace/taehyeok-jang.github.io/_posts/.assets/decaton-offset-commit-01-4801886.png" alt="decaton-offset-commit-01" /></p>

<ol>
  <li>1ë²ˆ ë©”ì‹œì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
  <li>1ë²ˆ ë©”ì‹œì§€ê°€ ì™„ë£Œë˜ì—ˆê³  ì£¼ê¸°ì  commit ì‹œë„ ì‹œì— commit ë˜ì–´ íì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
</ol>

<p><img src="/Users/tajang12/Documents/workspace/taehyeok-jang.github.io/_posts/.assets/decaton-offset-commit-02-4801892.png" alt="decaton-offset-commit-02" /></p>

<ol>
  <li>2~5ë²ˆ ë©”ì‹œì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
  <li>3~5ë²ˆ ë©”ì‹œì§€ê°€ ì™„ë£Œë˜ì—ˆì§€ë§Œ 2ë²ˆì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— ì£¼ê¸°ì  commit ì‹œë„ ì‹œì— ì–´ë–¤ ë©”ì‹œì§€ë„ commit ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</li>
</ol>

<p><img src="/Users/tajang12/Documents/workspace/taehyeok-jang.github.io/_posts/.assets/decaton-offset-commit-03-4801902.png" alt="decaton-offset-commit-03" /></p>

<ol>
  <li>6~7ë²ˆ ë©”ì‹œì§€ê°€ ì¶”ê°€ë˜ì—ˆê³  2ë²ˆ ë©”ì‹œì§€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</li>
  <li>ì£¼ê¸°ì  commit ì‹œë„ ì‹œì— 2ë²ˆ ë©”ì‹œì§€ì™€ í•¨ê»˜ 3~6ë²ˆ ë©”ì‹œì§€ë„ ì™„ë£Œë˜ì—ˆê¸° ë•Œë¬¸ì— commit ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
  <li>íì—ëŠ” 7ë²ˆ ë©”ì‹œì§€ë§Œ ë‚¨ì•„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤.</li>
</ol>

<p>ìœ„ sliding offset range ë™ì‘ ë°©ì‹ì„ Decatonì—ì„œëŠ” OutOfOrderCommitControl í´ë˜ìŠ¤ì—ì„œ dequeueì„ í™œìš©í•˜ì—¬ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.</p>

<p>https://github.com/line/decaton/blob/master/processor/src/main/java/com/linecorp/decaton/processor/runtime/internal/OutOfOrderCommitControl.java#L90-L126</p>

<h2 id="implementation">Implementation</h2>

<h3 id="overall-design">Overall Design</h3>

<p><img src="/Users/tajang12/Documents/workspace/taehyeok-jang.github.io/_posts/.assets/internal-queuing.png" alt="internal-queuing" /></p>

<h3 id="decatonprocessor">DecatonProcessor</h3>

<p>Decatonì—ì„œ êµ¬í˜„í•œ consumerë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ DecatonProcessor ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ì—¬ instance ì‹¤í–‰  ì‹œ consumer subscribe ë° ì´ˆê¸°í™”ë¥¼ ìœ„í•œ í´ë˜ìŠ¤ì¸ ProcessorSubsciptionì— ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤. ì—¬ëŸ¬ í”„ë¡œì„¸ì„œë¥¼ ë“±ë¡í•˜ì—¬ ë©”ì‹œì§€ë¥¼ íŒŒì´í”„ë¼ì¸ ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•˜ê±°ë‚˜ ì¬ì‹œë„ë¥¼ ìœ„í•œ í”„ë¡œì„¸ì„œë¥¼ ë“±ë¡í•˜ì—¬ fallback ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PrintMessageTaskProcessor</span> <span class="kd">implements</span> <span class="nc">DecatonProcessor</span><span class="o">&lt;</span><span class="nc">PrintMessageTask</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="nc">ProcessingContext</span><span class="o">&lt;</span><span class="nc">PrintMessageTask</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="nc">PrintMessageTask</span> <span class="n">task</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Noticed %s is %d years old\n"</span><span class="o">,</span> <span class="n">task</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">task</span><span class="o">.</span><span class="na">getAge</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ProcessorMain</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Properties</span> <span class="n">consumerConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
        <span class="n">consumerConfig</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">ConsumerConfig</span><span class="o">.</span><span class="na">CLIENT_ID_CONFIG</span><span class="o">,</span> <span class="s">"my-decaton-processor"</span><span class="o">);</span>
        <span class="n">consumerConfig</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">ConsumerConfig</span><span class="o">.</span><span class="na">BOOTSTRAP_SERVERS_CONFIG</span><span class="o">,</span>
                                   <span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"bootstrap.servers"</span><span class="o">));</span>
        <span class="n">consumerConfig</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="nc">ConsumerConfig</span><span class="o">.</span><span class="na">GROUP_ID_CONFIG</span><span class="o">,</span> <span class="s">"my-decaton-processor"</span><span class="o">);</span>

        <span class="nc">ProcessorSubscription</span> <span class="n">subscription</span> <span class="o">=</span>
                <span class="nc">SubscriptionBuilder</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">(</span><span class="s">"my-decaton-processor"</span><span class="o">)</span> <span class="c1">// (1)</span>
                                   <span class="o">.</span><span class="na">processorsBuilder</span><span class="o">(</span>
                                           <span class="nc">ProcessorsBuilder</span><span class="o">.</span><span class="na">consuming</span><span class="o">(</span>
                                                   <span class="s">"my-decaton-topic"</span><span class="o">,</span>
                                                   <span class="k">new</span> <span class="nc">ProtocolBuffersDeserializer</span><span class="o">&lt;&gt;(</span><span class="nc">PrintMessageTask</span><span class="o">.</span><span class="na">parser</span><span class="o">()))</span>
                                                            <span class="o">.</span><span class="na">thenProcess</span><span class="o">(</span><span class="k">new</span> <span class="nc">PrintMessageTaskProcessor</span><span class="o">())</span>
                                   <span class="o">)</span>
                                   <span class="o">.</span><span class="na">consumerConfig</span><span class="o">(</span><span class="n">consumerConfig</span><span class="o">)</span>
                                   <span class="o">.</span><span class="na">buildAndStart</span><span class="o">();</span>

        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
        <span class="n">subscription</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="processorsubscription">ProcessorSubscription</h3>

<p>ProcessorSubscriptionëŠ” topicì„ subscribeí•˜ê³ , ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ì „ì²´ ê³¼ì •ì„ ë‹´ê³  ìˆëŠ” classì…ë‹ˆë‹¤.</p>

<ol>
  <li>í”„ë¡œì„¸ì„œë¥¼ ì‹¤í–‰í•˜ì—¬ ë¸Œë¡œì»¤ë¡œë¶€í„° partitionì´ í• ë‹¹ë˜ë©´ AssignmentManagerë¥¼ í†µí•´ ê° partitionì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ì¸ PartitionContextë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</li>
  <li>ConsumeManagerëŠ” ë©”ì‹œì§€ë“¤ì„ pollí•˜ì—¬ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    <ol>
      <li>ê° ë©”ì‹œì§€ëŠ” ìì‹ ì˜ partitionì— ëŒ€ì‘ë˜ëŠ” PartitionContext ë‚´ì—ì„œ ì²˜ë¦¬ê°€ ë©ë‹ˆë‹¤.</li>
      <li>ë©”ì‹œì§€ë“¤ì„ ë™ê¸° í˜¹ì€ ë¹„ë™ê¸° ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•œ ë‹¤ìŒ ê° PartitionContextëŠ” high watermarkë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.</li>
      <li>íŠ¹ì • partitionì—ì„œ ì²˜ë¦¬ê°€ ì§€ì—°ë˜ëŠ” ìƒí™©ì—ì„œëŠ” ë©”ì‹œì§€ë“¤ì„ ë” ê°€ì ¸ì™€ë„ consumeì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ConsumerManagerëŠ” ê° PartitionContextê°€ max.pending.recordsì„ ì´ˆê³¼í•˜ëŠ” ë ˆì½”ë“œë“¤ì„ ì²˜ë¦¬í•˜ê³  ìˆìœ¼ë©´ í•´ë‹¹ partitionì€ ë‹¤ìŒ poll ë•Œ ë©”ì‹œì§€ë“¤ì„ ê°€ì ¸ì˜¤ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.</li>
    </ol>
  </li>
  <li>CommitManagerëŠ” ë§ˆì§€ë§‰ commitìœ¼ë¡œë¶€í„° commit.interval.ms ë§Œí¼ì˜ ì‹œê°„ì´ ì§€ë‚˜ë©´ ë¹„ë™ê¸° commitì„ í•©ë‹ˆë‹¤. ê° partition ë³„ë¡œ commit í•  offsetì€ PartitionContextì˜ high watermark offsetì…ë‹ˆë‹¤.</li>
  <li>Decatonì—ì„œ partition ë³„ ë™ì‹œ</li>
  <li>ë§Œì•½ partition.concurrency ê°’ì´ ë³€ê²½ë˜ì—ˆë‹¤ë©´ í•´ë‹¹ ê°œìˆ˜ë§Œí¼ ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ ìƒì„±í•©ë‹ˆë‹¤.</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProcessorSubscription</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="kd">implements</span> <span class="nc">AsyncShutdownable</span> <span class="o">{</span>
  <span class="nd">@Override</span> 
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">started</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">terminated</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">updateState</span><span class="o">(</span><span class="nc">SubscriptionStateListener</span><span class="o">.</span><span class="na">State</span><span class="o">.</span><span class="na">INITIALIZING</span><span class="o">);</span>
        <span class="n">consumeManager</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">subscribeTopics</span><span class="o">());</span>
        <span class="n">consumeLoop</span><span class="o">();</span> 
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">loopTerminateFuture</span><span class="o">.</span><span class="na">complete</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">consumeLoop</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">while</span> <span class="o">(!</span><span class="n">terminated</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">consumeManager</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
        <span class="n">contexts</span><span class="o">.</span><span class="na">maybeHandlePropertyReload</span><span class="o">();</span>

        <span class="n">commitManager</span><span class="o">.</span><span class="na">maybeCommitAsync</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="assignmentmanager">AssignmentManager</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AssignmentManager</span> <span class="o">{</span>
  
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AssignmentStore</span> <span class="n">store</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">assign</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">TopicPartition</span><span class="o">&gt;</span> <span class="n">newAssignment</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">TopicPartition</span><span class="o">&gt;</span> <span class="n">newSet</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(</span><span class="n">newAssignment</span><span class="o">);</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">TopicPartition</span><span class="o">&gt;</span> <span class="n">oldSet</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">assignedPartitions</span><span class="o">();</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">TopicPartition</span><span class="o">&gt;</span> <span class="n">removed</span> <span class="o">=</span> <span class="n">computeRemovedPartitions</span><span class="o">(</span><span class="n">oldSet</span><span class="o">,</span> <span class="n">newSet</span><span class="o">);</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">TopicPartition</span><span class="o">&gt;</span> <span class="n">added</span> <span class="o">=</span> <span class="n">computeAddedPartitions</span><span class="o">(</span><span class="n">oldSet</span><span class="o">,</span> <span class="n">newSet</span><span class="o">);</span>

    <span class="n">partitionsRevoked</span><span class="o">(</span><span class="n">removed</span><span class="o">);</span>
    <span class="n">partitionsAssigned</span><span class="o">(</span><span class="n">added</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">partitionsRevoked</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">TopicPartition</span><span class="o">&gt;</span> <span class="n">partitions</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">partitions</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">store</span><span class="o">.</span><span class="na">removePartition</span><span class="o">(</span><span class="n">partitions</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">partitionsAssigned</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">TopicPartition</span><span class="o">&gt;</span> <span class="n">partitions</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">partitions</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TopicPartition</span><span class="o">,</span> <span class="nc">AssignmentConfig</span><span class="o">&gt;</span> <span class="n">configs</span> <span class="o">=</span>
      <span class="n">partitions</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">toMap</span><span class="o">(</span><span class="nc">Function</span><span class="o">.</span><span class="na">identity</span><span class="o">(),</span> <span class="n">ignored</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AssignmentConfig</span><span class="o">(</span><span class="kc">false</span><span class="o">)));</span>
    <span class="n">store</span><span class="o">.</span><span class="na">addPartitions</span><span class="o">(</span><span class="n">configs</span><span class="o">);</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h4 id="consumemanager">ConsumeManager</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConsumeManager</span> <span class="kd">implements</span> <span class="nc">AutoCloseable</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">poll</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ConsumerRecords</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">records</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="no">POLL_TIMEOUT_MILLIS</span><span class="o">);</span>
    <span class="n">records</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nl">handler:</span><span class="o">:</span><span class="n">receive</span><span class="o">);</span>

    <span class="n">states</span><span class="o">.</span><span class="na">updatePartitionsStatus</span><span class="o">();</span>

    <span class="n">pausePartitions</span><span class="o">(</span><span class="n">consumer</span><span class="o">);</span>
    <span class="n">resumePartitions</span><span class="o">(</span><span class="n">consumer</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">subscribeTopics</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">TopicPartition</span><span class="o">&gt;</span> <span class="n">pausedPartitions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
    <span class="n">consumer</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">subscribeTopics</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ConsumerRebalanceListener</span><span class="o">()</span> <span class="o">{</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onPartitionsRevoked</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">TopicPartition</span><span class="o">&gt;</span> <span class="n">partitions</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">consumerClosing</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">{</span>
          <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">handler</span><span class="o">.</span><span class="na">prepareForRebalance</span><span class="o">();</span>
        <span class="n">pausedPartitions</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">consumer</span><span class="o">.</span><span class="na">paused</span><span class="o">());</span>
      <span class="o">}</span>

      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onPartitionsAssigned</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">TopicPartition</span><span class="o">&gt;</span> <span class="n">partitions</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">handler</span><span class="o">.</span><span class="na">updateAssignment</span><span class="o">(</span><span class="n">partitions</span><span class="o">);</span>

        <span class="n">pausedPartitions</span><span class="o">.</span><span class="na">retainAll</span><span class="o">(</span><span class="n">partitions</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="n">consumer</span><span class="o">.</span><span class="na">pause</span><span class="o">(</span><span class="n">pausedPartitions</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
          <span class="n">pausedPartitions</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">});</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="commitmanager">CommitManager</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommitManager</span> <span class="o">{</span> 
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">maybeCommitAsync</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">clock</span><span class="o">.</span><span class="na">millis</span><span class="o">()</span> <span class="o">-</span> <span class="n">lastCommittedMillis</span> <span class="o">&gt;=</span> <span class="n">commitIntervalMillis</span><span class="o">.</span><span class="na">value</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">commitAsync</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">lastCommittedMillis</span> <span class="o">=</span> <span class="n">clock</span><span class="o">.</span><span class="na">millis</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commitAsync</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TopicPartition</span><span class="o">,</span> <span class="nc">OffsetAndMetadata</span><span class="o">&gt;</span> <span class="n">offsets</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">commitReadyOffsets</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">offsets</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">asyncCommitInFlight</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">Thread</span> <span class="n">callingThread</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
    <span class="n">consumer</span><span class="o">.</span><span class="na">commitAsync</span><span class="o">(</span><span class="n">offsets</span><span class="o">,</span> <span class="o">(</span><span class="n">ignored</span><span class="o">,</span> <span class="n">exception</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="n">asyncCommitInFlight</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">exception</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">!=</span> <span class="n">callingThread</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"BUG: commitAsync callback triggered by an unexpected thread: {}."</span> <span class="o">+</span>
                  <span class="s">" Please report this to Decaton developers"</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">());</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="n">store</span><span class="o">.</span><span class="na">storeCommittedOffsets</span><span class="o">(</span><span class="n">offsets</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Unexpected exception caught while updating committed offset"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
                         <span class="o">});</span>
    <span class="n">asyncCommitInFlight</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h3 id="partitionprocessor">PartitionProcessor</h3>

<ul>
  <li>
    <p>Create and manage configured number of {@link ProcessorUnit}s to parallel-ize processing of tasks received from single partition.</p>
  </li>
  <li>
    <p>Route fed task appropriately to one of belonging {@link ProcessorUnit}s, respecting taskâ€™s key for keeping process locally and ordering.</p>
  </li>
  <li>
    <p>Manage lifecycle of {@link DecatonProcessor}s for each {@link ProcessorUnit}s.</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PartitionProcessor</span> <span class="kd">implements</span> <span class="nc">AsyncShutdownable</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">PartitionScope</span> <span class="n">scope</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Processors</span><span class="o">&lt;?&gt;</span> <span class="n">processors</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ProcessorUnit</span><span class="o">&gt;</span> <span class="n">units</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">SubPartitioner</span> <span class="n">subPartitioner</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RateLimiter</span> <span class="n">rateLimiter</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">PartitionProcessor</span><span class="o">(</span><span class="nc">PartitionScope</span> <span class="n">scope</span><span class="o">,</span> <span class="nc">Processors</span><span class="o">&lt;?&gt;</span> <span class="n">processors</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">scope</span> <span class="o">=</span> <span class="n">scope</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">processors</span> <span class="o">=</span> <span class="n">processors</span><span class="o">;</span>

    <span class="kt">int</span> <span class="n">concurrency</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">props</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="nc">ProcessorProperties</span><span class="o">.</span><span class="na">CONFIG_PARTITION_CONCURRENCY</span><span class="o">).</span><span class="na">value</span><span class="o">();</span>
    <span class="n">units</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">concurrency</span><span class="o">);</span>
    <span class="n">subPartitioner</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SubPartitioner</span><span class="o">(</span><span class="n">concurrency</span><span class="o">);</span>
    <span class="n">rateLimiter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DynamicRateLimiter</span><span class="o">(</span><span class="n">scope</span><span class="o">.</span><span class="na">props</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="nc">ProcessorProperties</span><span class="o">.</span><span class="na">CONFIG_PROCESSING_RATE</span><span class="o">));</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">concurrency</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">units</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">createUnit</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nc">ProcessorUnit</span> <span class="nf">createUnit</span><span class="o">(</span><span class="kt">int</span> <span class="n">threadId</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">ThreadScope</span> <span class="n">threadScope</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadScope</span><span class="o">(</span><span class="n">scope</span><span class="o">,</span> <span class="n">threadId</span><span class="o">);</span>
      <span class="nc">ExecutionScheduler</span> <span class="n">scheduler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExecutionScheduler</span><span class="o">(</span><span class="n">threadScope</span><span class="o">,</span> <span class="n">rateLimiter</span><span class="o">);</span>

      <span class="nc">TopicPartition</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">topicPartition</span><span class="o">();</span>
      <span class="nc">ProcessPipeline</span><span class="o">&lt;?&gt;</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">processors</span><span class="o">.</span><span class="na">newPipeline</span><span class="o">(</span><span class="n">threadScope</span><span class="o">,</span> <span class="n">scheduler</span><span class="o">,</span> <span class="n">metrics</span><span class="o">);</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">ProcessorUnit</span><span class="o">(</span><span class="n">threadScope</span><span class="o">,</span> <span class="n">pipeline</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addTask</span><span class="o">(</span><span class="nc">TaskRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">subPartition</span> <span class="o">=</span> <span class="n">subPartitioner</span><span class="o">.</span><span class="na">partitionFor</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">key</span><span class="o">());</span>
      <span class="n">units</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">subPartition</span><span class="o">).</span><span class="na">putTask</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div></div>

<h4 id="processorunit-processpipeline">ProcessorUnit, ProcessPipeline</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProcessorUnit</span> <span class="kd">implements</span> <span class="nc">AsyncShutdownable</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ProcessPipeline</span><span class="o">&lt;?&gt;</span> <span class="n">pipeline</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ExecutorService</span> <span class="n">executor</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">putTask</span><span class="o">(</span><span class="nc">TaskRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">processTask</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">processTask</span><span class="o">(</span><span class="nc">TaskRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">scheduleThenProcess</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProcessPipeline</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">AutoCloseable</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">scheduleThenProcess</span><span class="o">(</span><span class="nc">TaskRequest</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">OffsetState</span> <span class="n">offsetState</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">offsetState</span><span class="o">();</span>
        <span class="kd">final</span> <span class="nc">DecatonTask</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">extracted</span> <span class="o">=</span> <span class="n">extract</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

        <span class="n">scheduler</span><span class="o">.</span><span class="na">schedule</span><span class="o">(</span><span class="n">extracted</span><span class="o">.</span><span class="na">metadata</span><span class="o">());</span>

        <span class="nc">Completion</span> <span class="n">result</span> <span class="o">=</span> <span class="n">process</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">extracted</span><span class="o">);</span>
        <span class="n">offsetState</span><span class="o">.</span><span class="na">completion</span><span class="o">().</span><span class="na">completeWith</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="kt">long</span> <span class="n">timeoutMs</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">props</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="nc">ProcessorProperties</span><span class="o">.</span><span class="na">CONFIG_DEFERRED_COMPLETE_TIMEOUT_MS</span><span class="o">).</span><span class="na">value</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">timeoutMs</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">expireAt</span> <span class="o">=</span> <span class="n">clock</span><span class="o">.</span><span class="na">millis</span><span class="o">()</span> <span class="o">+</span> <span class="n">timeoutMs</span><span class="o">;</span>
            <span class="n">offsetState</span><span class="o">.</span><span class="na">setTimeout</span><span class="o">(</span><span class="n">expireAt</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="internal-queueing-and-workers">Internal Queueing and Workers</h2>

<h2 id="references">References</h2>

<ul>
  <li>https://github.com/line/decaton</li>
  <li>https://www.confluent.io/blog/kafka-consumer-multi-threaded-messaging/</li>
  <li>https://www.confluent.io/blog/introducing-confluent-parallel-message-processing-client/</li>
  <li>https://www.confluent.io/blog/how-choose-number-topics-partitions-kafka-cluster/</li>
  <li>https://kafka.apache.org</li>
  <li>https://dzone.com/articles/kafka-topic-architecture-replication-failover-and</li>
  <li>LINE Engineering Blog
    <ul>
      <li>https://engineering.linecorp.com/ko/blog/how-to-use-kafka-in-line-1/</li>
      <li>https://engineering.linecorp.com/ko/blog/how-to-use-kafka-in-line-2/</li>
      <li>https://engineering.linecorp.com/ko/blog/how-to-use-kafka-in-line-3/</li>
      <li>https://engineering.linecorp.com/ko/blog/decaton-case-studies/</li>
      <li>https://speakerdeck.com/line_devday2020/decaton-high-performance-task-processing-with-kafka?slide=16</li>
    </ul>
  </li>
</ul>

<p><a href="https://www.youtube.com/watch?v=lk27yiITOvU">TCP sliding window with error animation</a></p>

:ET